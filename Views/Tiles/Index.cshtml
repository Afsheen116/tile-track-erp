@model IEnumerable<CeramicERP.Models.Tile>
@{
    ViewData["Title"] = "Tiles";

    var totalTiles = Convert.ToInt32(ViewBag.TotalTiles ?? 0);
    var totalStock = Convert.ToInt32(ViewBag.TotalStock ?? 0);
    var lowStockTiles = Convert.ToInt32(ViewBag.LowStockTiles ?? 0);
    var totalInventoryValue = Convert.ToDecimal(ViewBag.TotalInventoryValue ?? 0m);
    var hasTiles = false;
    var canManageInventory = User.HasPermission(PermissionNames.ManageInventory);
    var canViewReports = User.HasPermission(PermissionNames.ViewReports);
    var emptyColSpan = canManageInventory ? 8 : 7;
}

<section class="ledger-page">
    <div class="ledger-heading">
        <div>
            <h2 class="ledger-title">Tiles Inventory</h2>
            <p class="ledger-subtitle">
                @(canViewReports
                    ? "Tile-wise stock, price, valuation and status. Click a row to open full tile profile and transaction timeline."
                    : "Tile-wise stock and low-stock visibility for day-to-day operations.")
            </p>
        </div>
        @if (canManageInventory)
        {
            <a class="btn ledger-primary-btn" asp-action="Create">Add Tile</a>
        }
    </div>

    <div class="ledger-stat-grid">
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Total Tiles</span>
            <span class="ledger-stat-value">@totalTiles</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Available Stock</span>
            <span class="ledger-stat-value">@totalStock Boxes</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Low Stock Tiles</span>
            <span class="ledger-stat-value @(lowStockTiles > 0 ? "text-danger" : "text-success")">@lowStockTiles</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Inventory Value</span>
            <span class="ledger-stat-value">Rs. @totalInventoryValue.ToString("N2")</span>
        </article>
    </div>

    <div class="ledger-table-card">
        <div class="ledger-table-header">
            <h3>Tile Overview</h3>
            <span>@(canViewReports ? "Click row to open tile details" : "Detailed analytics restricted")</span>
        </div>

        <div class="table-responsive">
            <table class="table ledger-table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Tile</th>
                        <th>Category</th>
                        <th>Size</th>
                        <th class="text-end">Price / Box</th>
                        <th class="text-end">Stock</th>
                        <th class="text-end">Stock Value</th>
                        <th class="text-center">Status</th>
                        @if (canManageInventory)
                        {
                            <th>Action</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        hasTiles = true;
                        var lowStock = item.StockQuantity <= item.LowStockThreshold;
                        var detailsUrl = Url.Action("Details", "Tiles", new { id = item.Id });

                        <tr class="@(canViewReports ? "ledger-clickable-row" : string.Empty)"
                            tabindex="@(canViewReports ? "0" : null)"
                            role="@(canViewReports ? "link" : null)"
                            data-ledger-url="@(canViewReports ? detailsUrl : string.Empty)"
                            aria-label="@(canViewReports ? $"Open tile details for {item.Name}" : null)">
                            <td>
                                <span class="@(canViewReports ? "ledger-entity-link" : string.Empty)">@item.Name</span>
                            </td>
                            <td>@item.Category?.Name</td>
                            <td>@item.Size</td>
                            <td class="text-end">Rs. @item.PricePerBox.ToString("N2")</td>
                            <td class="text-end">@item.StockQuantity</td>
                            <td class="text-end">Rs. @((item.PricePerBox * item.StockQuantity).ToString("N2"))</td>
                            <td class="text-center">
                                <span class="inventory-status-pill @(lowStock ? "inventory-status-alert" : "inventory-status-good")">
                                    @(lowStock ? "Low" : "Healthy")
                                </span>
                            </td>
                            @if (canManageInventory)
                            {
                                <td>
                                    <a class="btn btn-danger btn-sm"
                                       asp-action="Delete"
                                       asp-route-id="@item.Id"
                                       onclick="return confirm('Delete this tile?');">
                                        Delete
                                    </a>
                                </td>
                            }
                        </tr>
                    }

                    @if (!hasTiles)
                    {
                        <tr>
                            <td colspan="@emptyColSpan" class="text-center py-4 text-muted">No tiles found. Add a tile to start managing inventory.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>
