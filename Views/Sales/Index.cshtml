@model IEnumerable<CeramicERP.Models.Sale>
@{
    ViewData["Title"] = "Sales";

    var totalRevenue = Convert.ToDecimal(ViewBag.TotalRevenue ?? 0m);
    var totalReceived = Convert.ToDecimal(ViewBag.TotalReceived ?? 0m);
    var totalPending = Convert.ToDecimal(ViewBag.TotalPending ?? 0m);
    var uniqueCustomers = Convert.ToInt32(ViewBag.UniqueCustomers ?? 0);
    var hasSales = false;
    var canCreateSale = User.HasPermission(PermissionNames.CreateSale);
    var canViewLedger = User.HasPermission(PermissionNames.ViewLedger);
}

<section class="ledger-page">
    <div class="ledger-heading">
        <div>
            <h2 class="ledger-title">Sales</h2>
            <p class="ledger-subtitle">
                @(canViewLedger
                    ? "Click a customer name to open their ledger account and full transaction history."
                    : "Sales history and receivable status overview.")
            </p>
        </div>
        @if (canCreateSale)
        {
            <a class="btn ledger-primary-btn" asp-action="Create">Add Sale</a>
        }
    </div>

    <div class="ledger-stat-grid">
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Total Revenue</span>
            <span class="ledger-stat-value">Rs. @totalRevenue.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Received</span>
            <span class="ledger-stat-value">Rs. @totalReceived.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Pending Receivable</span>
            <span class="ledger-stat-value text-danger">Rs. @totalPending.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Active Customers</span>
            <span class="ledger-stat-value">@uniqueCustomers</span>
        </article>
    </div>

    <div class="ledger-table-card">
        <div class="ledger-table-header">
            <h3>Customer Transactions</h3>
            <span>@(canViewLedger ? "Enterprise Ledger Enabled" : "Ledger Access Restricted")</span>
        </div>

        <div class="table-responsive">
            <table class="table ledger-table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Date</th>
                        <th>Payment Type</th>
                        <th class="text-end">Total</th>
                        <th class="text-end">Received</th>
                        <th class="text-end">Pending</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var sale in Model)
                    {
                        hasSales = true;
                        var ledgerUrl = Url.Action("Details", "EnterpriseLedger", new { enterpriseName = sale.CustomerName });
                        <tr class="@(canViewLedger ? "ledger-clickable-row" : string.Empty)"
                            tabindex="@(canViewLedger ? "0" : null)"
                            role="@(canViewLedger ? "link" : null)"
                            data-ledger-url="@(canViewLedger ? ledgerUrl : string.Empty)"
                            aria-label="@(canViewLedger ? $"Open ledger for {sale.CustomerName}" : null)">
                            <td>
                                <span class="@(canViewLedger ? "ledger-entity-link" : string.Empty)">@sale.CustomerName</span>
                            </td>
                            <td>@sale.SaleDate.ToString("dd-MMM-yyyy hh:mm tt")</td>
                            <td>@sale.PaymentType</td>
                            <td class="text-end">Rs. @sale.TotalAmount.ToString("N2")</td>
                            <td class="text-end">Rs. @sale.PaidAmount.ToString("N2")</td>
                            <td class="text-end @(sale.DueAmount > 0 ? "text-danger fw-semibold" : "text-success fw-semibold")">
                                Rs. @sale.DueAmount.ToString("N2")
                            </td>
                        </tr>
                    }

                    @if (!hasSales)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">No sales records available yet.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>
