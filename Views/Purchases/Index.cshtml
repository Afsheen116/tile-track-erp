@model IEnumerable<CeramicERP.Models.Purchase>
@{
    ViewData["Title"] = "Purchases";

    var totalCost = Convert.ToDecimal(ViewBag.TotalCost ?? 0m);
    var totalPaid = Convert.ToDecimal(ViewBag.TotalPaid ?? 0m);
    var totalPending = Convert.ToDecimal(ViewBag.TotalPending ?? 0m);
    var uniqueSuppliers = Convert.ToInt32(ViewBag.UniqueSuppliers ?? 0);
    var hasPurchases = false;
    var canCreatePurchase = User.HasPermission(PermissionNames.CreatePurchase);
    var canViewLedger = User.HasPermission(PermissionNames.ViewLedger);
}

<section class="ledger-page">
    <div class="ledger-heading">
        <div>
            <h2 class="ledger-title">Purchases</h2>
            <p class="ledger-subtitle">
                @(canViewLedger
                    ? "Click a supplier name to open their ledger account and complete purchase history."
                    : "Purchase history and payable status overview.")
            </p>
        </div>
        @if (canCreatePurchase)
        {
            <a class="btn ledger-primary-btn" asp-action="Create">Add Purchase</a>
        }
    </div>

    <div class="ledger-stat-grid">
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Total Purchase Cost</span>
            <span class="ledger-stat-value">Rs. @totalCost.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Amount Paid</span>
            <span class="ledger-stat-value">Rs. @totalPaid.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Pending Payable</span>
            <span class="ledger-stat-value text-danger">Rs. @totalPending.ToString("N2")</span>
        </article>
        <article class="ledger-stat-card">
            <span class="ledger-stat-label">Active Suppliers</span>
            <span class="ledger-stat-value">@uniqueSuppliers</span>
        </article>
    </div>

    <div class="ledger-table-card">
        <div class="ledger-table-header">
            <h3>Supplier Transactions</h3>
            <span>@(canViewLedger ? "Enterprise Ledger Enabled" : "Ledger Access Restricted")</span>
        </div>

        <div class="table-responsive">
            <table class="table ledger-table align-middle mb-0">
                <thead>
                    <tr>
                        <th>Supplier</th>
                        <th>Date</th>
                        <th>Payment Type</th>
                        <th class="text-end">Total</th>
                        <th class="text-end">Paid</th>
                        <th class="text-end">Pending</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var purchase in Model)
                    {
                        hasPurchases = true;
                        var ledgerUrl = Url.Action("Details", "EnterpriseLedger", new { enterpriseName = purchase.SupplierName });
                        <tr class="@(canViewLedger ? "ledger-clickable-row" : string.Empty)"
                            tabindex="@(canViewLedger ? "0" : null)"
                            role="@(canViewLedger ? "link" : null)"
                            data-ledger-url="@(canViewLedger ? ledgerUrl : string.Empty)"
                            aria-label="@(canViewLedger ? $"Open ledger for {purchase.SupplierName}" : null)">
                            <td>
                                <span class="@(canViewLedger ? "ledger-entity-link" : string.Empty)">@purchase.SupplierName</span>
                            </td>
                            <td>@purchase.PurchaseDate.ToString("dd-MMM-yyyy hh:mm tt")</td>
                            <td>@purchase.PaymentType</td>
                            <td class="text-end">Rs. @purchase.TotalAmount.ToString("N2")</td>
                            <td class="text-end">Rs. @purchase.PaidAmount.ToString("N2")</td>
                            <td class="text-end @(purchase.DueAmount > 0 ? "text-danger fw-semibold" : "text-success fw-semibold")">
                                Rs. @purchase.DueAmount.ToString("N2")
                            </td>
                        </tr>
                    }

                    @if (!hasPurchases)
                    {
                        <tr>
                            <td colspan="6" class="text-center py-4 text-muted">No purchase records available yet.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</section>
